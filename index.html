<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ahanitya Order Portal (Single File)</title>
  <style>
    :root{--brand:#14532d;--ink:#111;--muted:#667085;--bg:#f6f7fb;--card:#fff;--line:#eef1f7}
    body{font-family:system-ui,Arial;margin:0;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .card{background:var(--card);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,select,button,textarea{padding:10px;border-radius:10px;border:1px solid #d7dbe7;font-size:14px}
    button{cursor:pointer;border:0;background:var(--brand);color:#fff;padding:10px 14px}
    button.secondary{background:#243b53}
    button.ghost{background:#e9edf7;color:#111}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px;vertical-align:top}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef7f0;color:var(--brand);font-size:12px}
    .muted{color:var(--muted);font-size:13px}
    .right{text-align:right}
    .tabs button{background:#e9edf7;color:#111}
    .tabs button.active{background:var(--brand);color:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 820px){.grid2{grid-template-columns:1fr}}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .warn{background:#fff4e5;border:1px solid #ffe0b2;color:#7a4b00;padding:10px;border-radius:12px}
  </style>

  <!-- Firebase Phone OTP (required for OTP login) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="topbar">
      <div>
        <h2 style="margin:0">Ahanitya Order Portal</h2>
        <div class="muted">Single-file portal: OTP for customers + Password for MR/Admin + Catalog + Cart + Email submission.</div>
      </div>
      <div class="pill" id="envPill">Not logged in</div>
    </div>
  </div>

  <div class="card warn">
    <b>Setup required:</b>
    <ol style="margin:8px 0 0 18px">
      <li>Paste your <b>Apps Script Web App URL</b> in <code>APPS_SCRIPT_URL</code></li>
      <li>Paste your <b>Firebase config</b> in <code>firebaseConfig</code></li>
      <li>Make sure your Apps Script supports actions: <code>LOGIN_PASSWORD</code> and <code>SUBMIT_ORDER</code></li>
    </ol>
  </div>

  <!-- LOGIN SELECT -->
  <div class="card" id="loginSelector">
    <h3 style="margin:0 0 10px">Login</h3>
    <div class="tabs row">
      <button id="tabOtp" class="active">Customer OTP Login</button>
      <button id="tabPass">MR / Super Admin Password Login</button>
    </div>
  </div>

  <!-- OTP LOGIN -->
  <div class="card" id="otpLoginCard">
    <h3 style="margin-top:0">OTP Login (Super Admin Only)</h3>
    <p class="muted">Enter phone number with country code (India: +918487090212).</p>

    <div class="row">
      <input id="phone" placeholder="+91XXXXXXXXXX" />
      <button id="sendOtpBtn">Send OTP</button>
    </div>

    <div id="recaptcha-container" style="margin-top:10px;"></div>

    <div class="row" style="margin-top:10px;">
      <input id="otp" placeholder="Enter OTP" />
      <button class="secondary" id="verifyOtpBtn">Verify & Continue</button>
    </div>

    <p class="muted" id="otpMsg"></p>
  </div>

  <!-- PASSWORD LOGIN -->
  <div class="card hidden" id="passLoginCard">
    <h3 style="margin-top:0">Password Login (MR / Super Admin)</h3>
    <div class="row">
      <input id="username" placeholder="Username" value="Ahanitya86" />
      <input id="password" placeholder="Password" type="password" value="Ahanitya@123" />
      <button id="passLoginBtn">Login</button>
    </div>
    <p class="muted" id="passMsg"></p>
  </div>

  <!-- PORTAL HEADER -->
  <div class="card hidden" id="portalCard">
    <div class="topbar">
      <div>
        <h3 style="margin:0">Portal</h3>
        <div class="muted">Logged in as: <b><span id="who"></span></b> <span class="pill" id="rolePill">-</span></div>
      </div>
      <button class="ghost" id="logoutBtn">Logout</button>
    </div>

    <hr style="border:none;border-top:1px solid var(--line);margin:14px 0"/>

    <div class="row">
      <select id="businessType">
        <option value="">Select Business Type</option>
        <option value="DOCTOR">Doctor</option>
        <option value="HOSPITAL">Hospital</option>
        <option value="DISTRIBUTOR">Distributor</option>
        <option value="RETAILER">Retail Medical Store</option>
      </select>

      <input id="partyName" placeholder="Name (Doctor/Hospital/Store)" style="flex:1;min-width:220px"/>
      <input id="partyCity" placeholder="City" />
      <input id="partyGst" placeholder="GST (optional)" />
    </div>

    <!-- SUPER ADMIN OVERRIDES -->
    <div class="card hidden" id="adminBox" style="margin-top:12px">
      <h3 style="margin-top:0">Super Admin Controls</h3>
      <div class="row">
        <select id="orderUnderMr" style="min-width:260px">
          <option value="">Order Under MR (select)</option>
        </select>
        <input id="adminDiscount" placeholder="Discount % (e.g., 5)" type="number" min="0" max="100"/>
        <input id="adminMrExtra" placeholder="MR Extra % (e.g., 2)" type="number" min="0" max="100"/>
      </div>
      <p class="muted">These values will be included in the order email.</p>
    </div>
  </div>

  <!-- CATALOG -->
  <div class="card hidden" id="catalogCard">
    <div class="topbar">
      <h3 style="margin:0">Product Catalog</h3>
      <input id="search" placeholder="Search product..." style="min-width:260px"/>
    </div>
    <p class="muted" style="margin-top:8px">Prices auto-adjust based on selected business type. (Edit multipliers in code if needed.)</p>

    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>Product</th>
            <th>Strength</th>
            <th>Type</th>
            <th>Category</th>
            <th class="right">Price (₹)</th>
            <th class="right">Qty</th>
            <th class="right">Add</th>
          </tr>
        </thead>
        <tbody id="catalogBody"></tbody>
      </table>
    </div>
  </div>

  <!-- CART / ORDER -->
  <div class="card hidden" id="cartCard">
    <div class="topbar">
      <h3 style="margin:0">Your Order</h3>
      <span class="pill" id="cartCount">0 items</span>
    </div>

    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th class="right">Price</th>
            <th class="right">Qty</th>
            <th class="right">Total</th>
            <th class="right">Remove</th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
      </table>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <div class="right">
        <div class="muted">Grand Total</div>
        <div style="font-size:20px;font-weight:800">₹ <span id="grandTotal">0</span></div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid var(--line);margin:14px 0"/>

    <h3 style="margin:0 0 10px">Delivery Details</h3>
    <div class="grid2">
      <input id="deliveryAddress" placeholder="Delivery Address" />
      <input id="pincode" placeholder="Pincode" />
    </div>
    <div class="row" style="margin-top:10px">
      <textarea id="notes" placeholder="Notes / Requirements" style="width:100%;min-height:90px"></textarea>
    </div>

    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="submitOrderBtn">Submit Order (Email)</button>
    </div>

    <p class="muted" id="orderMsg"></p>
  </div>

</div>

<script>
/** =========================
 * SETTINGS YOU MUST FILL
 * ========================= */
const APPS_SCRIPT_URL = "PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE"; // <-- paste Apps Script Web App URL

// Paste Firebase config below
const firebaseConfig = {
  apiKey: "AIzaSyBAEpP__iHjBF9RyrSE9Uql52bgFSK64NU",
  authDomain: "aplsl-otp.firebaseapp.com",
  projectId: "aplsl-otp",
  storageBucket: "aplsl-otp.firebasestorage.app",
  messagingSenderId: "815906389527",
  appId: "1:815906389527:web:8e52001a2467c0778aa652",
  measurementId: "G-GNKBDTDLW0"
};

// ✅ OTP only for Super Admin (edit numbers)
const SUPER_ADMIN_NUMBERS = [
  "+918487090212" // e.g. "+919876543210"
];


/** =========================
 * PRODUCT PORTFOLIO (edit/add)
 * ========================= */
const PRODUCTS = [
  { sku:"AZIN-500", name:"Azithromycin Tablets I.P", strength:"500 mg", type:"Tablet", category:"Rx", mrp:700 },
  { sku:"ASP-15", name:"Aceclofenac + Paracetamol + Serratiopeptidase", strength:"100/325/15 mg", type:"Tablet", category:"Rx", mrp:1200 },
  { sku:"PANTO-DSR", name:"Pantoprazole + Domperidone", strength:"40/30 mg", type:"Capsule", category:"Rx", mrp:900 },
  { sku:"MONT-LEV", name:"Montelukast + Levocetirizine", strength:"10 mg + 5 mg", type:"Tablet", category:"Rx", mrp:650 },
  { sku:"D3-2000-STRIP", name:"Vitamin D3 Mouth Dissolving Strip", strength:"2000 IU", type:"Strip", category:"Nutraceutical", mrp:399 }
];

/** Pricing multiplier by business type (customize anytime) */
function getPriceForRole(product, role){
  const base = Number(product.mrp || 0);
  const mult = { DOCTOR:1.00, HOSPITAL:0.98, RETAILER:0.92, DISTRIBUTOR:0.88 }[role] ?? 1.00;
  return Math.round(base * mult);
}

/** =========================
 * STATE
 * ========================= */
let loginMode = null;         // "OTP" or "PASSWORD"
let otpPhone = "";
let sessionToken = null;      // password sessions
let sessionUser = null;       // {role, username, name}
let mrList = [];              // for Super Admin dropdown

const cart = new Map(); // sku -> {product, qty, unitPrice}

/** =========================
 * INIT AUTH (Firebase)
 * ========================= */
let auth = null;
try{
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
}catch(e){
  // If firebaseConfig is not filled, OTP won't work. Keep password login usable.
  console.warn("Firebase not initialized. Fill firebaseConfig to enable OTP.", e);
}

/** =========================
 * TABS (OTP vs Password)
 * ========================= */
const tabOtp = document.getElementById('tabOtp');
const tabPass = document.getElementById('tabPass');
const otpCard = document.getElementById('otpLoginCard');
const passCard = document.getElementById('passLoginCard');

tabOtp.onclick = () => {
  tabOtp.classList.add('active'); tabPass.classList.remove('active');
  otpCard.classList.remove('hidden'); passCard.classList.add('hidden');
};
tabPass.onclick = () => {
  tabPass.classList.add('active'); tabOtp.classList.remove('active');
  passCard.classList.remove('hidden'); otpCard.classList.add('hidden');
};

/** =========================
 * OTP LOGIN
 * ========================= */
let confirmationResult = null;
let recaptchaVerifier = null;

function ensureRecaptcha(){
  if(!auth) throw new Error("Firebase not configured. Paste firebaseConfig first.");
  if(recaptchaVerifier) return;
  recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
}

document.getElementById('sendOtpBtn').onclick = async () => {
  const msg = document.getElementById('otpMsg');
  msg.textContent = "";
  try{
    ensureRecaptcha();
    const phone = document.getElementById('phone').value.trim();
    if(!phone.startsWith("+")) throw new Error("Enter phone with country code. Example: +91XXXXXXXXXX");
    // ✅ Allow OTP only for Super Admin numbers
    if(!SUPER_ADMIN_NUMBERS.includes(phone)) throw new Error("OTP allowed only for Super Admin numbers.");
    confirmationResult = await auth.signInWithPhoneNumber(phone, recaptchaVerifier);
    msg.textContent = "OTP sent to your phone.";
  }catch(e){
    msg.textContent = "OTP error: " + (e.message || e);
  }
};

document.getElementById('verifyOtpBtn').onclick = async () => {
  const msg = document.getElementById('otpMsg');
  msg.textContent = "";
  try{
    if(!confirmationResult) throw new Error("Please send OTP first.");
    const code = document.getElementById('otp').value.trim();
    const result = await confirmationResult.confirm(code);
    loginMode = "OTP";
    otpPhone = result.user.phoneNumber || "";
    showPortal({ role:"SUPER_ADMIN", name: otpPhone });
  }catch(e){
    msg.textContent = "Verify error: " + (e.message || e);
  }
};

/** =========================
 * PASSWORD LOGIN (MR/Admin)
 * ========================= */
document.getElementById('passLoginBtn').onclick = async () => {
  const msg = document.getElementById('passMsg');
  msg.textContent = "Logging in...";
  try{
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const res = await fetch(APPS_SCRIPT_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"LOGIN_PASSWORD", username, password })
    });
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "Login failed");

    loginMode = "PASSWORD";
    sessionToken = data.token;
    sessionUser = data.user;
    mrList = data.mrList || [];

    showPortal(sessionUser);
    msg.textContent = "";
  }catch(e){
    msg.textContent = "Login error: " + (e.message || e);
  }
};

/** =========================
 * SHOW PORTAL
 * ========================= */
function showPortal(user){
  document.getElementById('envPill').textContent = "Logged in";
  document.getElementById('loginSelector').classList.add('hidden');
  otpCard.classList.add('hidden');
  passCard.classList.add('hidden');

  document.getElementById('portalCard').classList.remove('hidden');
  document.getElementById('catalogCard').classList.remove('hidden');
  document.getElementById('cartCard').classList.remove('hidden');

  document.getElementById('who').textContent = user.name || user.username || "";
  document.getElementById('rolePill').textContent = user.role || "-";

  // super admin controls
  const adminBox = document.getElementById('adminBox');
  if(user.role === "SUPER_ADMIN"){
    adminBox.classList.remove('hidden');
    const sel = document.getElementById('orderUnderMr');
    sel.innerHTML = '<option value="">Order Under MR (select)</option>' +
      mrList.map(m => `<option value="${m.username}">${m.name} (${m.username})</option>`).join('');
  }else{
    adminBox.classList.add('hidden');
  }

  renderCatalog();
  renderCart();
}

document.getElementById('logoutBtn').onclick = async () => {
  try{ if(auth) await auth.signOut(); }catch(e){}
  location.reload();
};

/** =========================
 * CATALOG + CART
 * ========================= */
function renderCatalog(){
  const role = document.getElementById('businessType').value;
  const q = (document.getElementById('search').value || '').toLowerCase();
  const body = document.getElementById('catalogBody');
  body.innerHTML = "";

  PRODUCTS
    .filter(p => (p.sku+p.name+p.strength+p.type+p.category).toLowerCase().includes(q))
    .forEach(p => {
      const price = role ? getPriceForRole(p, role) : Number(p.mrp||0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${p.sku}</b><div class="muted">${p.name}</div></td>
        <td>${p.strength}</td>
        <td>${p.type}</td>
        <td>${p.category}</td>
        <td class="right">${price}</td>
        <td class="right"><input type="number" min="1" value="1" style="width:80px" id="qty_${p.sku}"></td>
        <td class="right"><button>Add</button></td>
      `;
      tr.querySelector('button').onclick = () => {
        if(!role){ alert("Please select Business Type first."); return; }
        const qty = parseInt(document.getElementById(`qty_${p.sku}`).value || "1", 10);
        addToCart(p, qty, price);
      };
      body.appendChild(tr);
    });
}

function addToCart(product, qty, unitPrice){
  const existing = cart.get(product.sku);
  if(existing){
    existing.qty += qty;
    existing.unitPrice = unitPrice;
  }else{
    cart.set(product.sku, { product, qty, unitPrice });
  }
  renderCart();
}

function removeFromCart(sku){
  cart.delete(sku);
  renderCart();
}

function renderCart(){
  const body = document.getElementById('cartBody');
  body.innerHTML = "";
  let total = 0;
  let items = 0;

  cart.forEach((v, sku) => {
    const line = v.qty * v.unitPrice;
    total += line;
    items += 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${sku}</b><div class="muted">${v.product.name}</div></td>
      <td class="right">${v.unitPrice}</td>
      <td class="right">${v.qty}</td>
      <td class="right">${line}</td>
      <td class="right"><button class="secondary">Remove</button></td>
    `;
    tr.querySelector('button').onclick = () => removeFromCart(sku);
    body.appendChild(tr);
  });

  document.getElementById('grandTotal').textContent = total;
  document.getElementById('cartCount').textContent = `${items} items`;
}

document.getElementById('search').addEventListener('input', renderCatalog);
document.getElementById('businessType').addEventListener('change', () => { renderCatalog(); });

/** =========================
 * SUBMIT ORDER (Email via Apps Script)
 * ========================= */
document.getElementById('submitOrderBtn').addEventListener('click', submitOrder);

async function submitOrder(){
  const msg = document.getElementById('orderMsg');
  msg.textContent = "";

  const businessType = document.getElementById('businessType').value;
  const partyName = document.getElementById('partyName').value.trim();
  const partyCity = document.getElementById('partyCity').value.trim();
  const partyGst = document.getElementById('partyGst').value.trim();

  if(!businessType || !partyName){
    msg.textContent = "Please select Business Type and enter Name.";
    return;
  }
  if(cart.size === 0){
    msg.textContent = "Cart is empty. Please add items.";
    return;
  }

  const payload = {
    action: "SUBMIT_ORDER",
    token: sessionToken, // null for OTP users
    loginMode: loginMode || "",
    loginPhone: otpPhone || "",

    role: businessType,
    partyName, partyCity, partyGst,

    deliveryAddress: document.getElementById('deliveryAddress').value.trim(),
    pincode: document.getElementById('pincode').value.trim(),
    notes: document.getElementById('notes').value.trim(),

    grandTotal: document.getElementById('grandTotal').textContent,
    items: Array.from(cart.values()).map(v => ({
      sku: v.product.sku,
      name: v.product.name,
      strength: v.product.strength,
      type: v.product.type,
      category: v.product.category,
      unitPrice: v.unitPrice,
      qty: v.qty,
      lineTotal: v.qty * v.unitPrice
    })),

    // default empty overrides
    orderUnderMr: "",
    adminDiscountPercent: "",
    adminMrExtraPercent: ""
  };

  // super admin overrides (if logged in by password)
  if(sessionUser && sessionUser.role === "SUPER_ADMIN"){
    payload.orderUnderMr = document.getElementById('orderUnderMr').value || "";
    payload.adminDiscountPercent = document.getElementById('adminDiscount').value || "";
    payload.adminMrExtraPercent = document.getElementById('adminMrExtra').value || "";
  }

  msg.textContent = "Submitting...";

  try{
    const res = await fetch(APPS_SCRIPT_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "Submit failed");

    msg.textContent = "✅ Order submitted successfully.";
    cart.clear();
    renderCart();
  }catch(e){
    msg.textContent = "❌ " + (e.message || e);
  }
}
</script>
</body>
</html>
